<!DOCTYPE html>
<html>
    <head>
        <title> 京东商城－购物车 </title>
        <meta charset="utf-8"/>
        <link rel="stylesheet" href="jdnet.css">
        <link rel="icon" href="img/favicon.ico">
        <link rel="stylesheet" href="css/jd.css">
        <link rel="stylesheet" href="css/addorder.css">
    </head>

    <body>
    <div id="header"></div>
    <div id="main">
        <div id="main">
            <div class="add-order">
                <header class="checkout-tit">
                    <span class="tit-txt">填写并核对订单信息</span>
                </header>
                <section class="checkout-steps">
                    <div class="step-tit">
                        <h3>收货人信息</h3>

                        <form id="form-order"></form>

                        <div class="extra-r">
                            <a href="#none" class="ftx-05">新增收货地址</a>
                        </div>
                    </div>
                    <div class="step-cont">
                        <div class="addr-detail">
                            <span class="addr-name" limit="6" title="刘强东">刘强东</span>
                            <input form="form-order" type="hidden" name="rcvName" value="刘强东">
                            <span class="addr-info" limit="45" title="北京 海淀区 三环到四环之间 太阳园小区4号楼101室">北京 海淀区 三环到四环之间 太阳园小区4号楼101室</span>
                            <input form="form-order" type="hidden" name="rcvAddr" value="北京 海淀区 三环到四环之间 太阳园小区4号楼101室">
                            <span class="addr-tel">136****1379</span>
                            <input form="form-order" type="hidden" name="rcvPhone" value="13612301379">
                        </div>
                    </div>
                    <div class="hr"></div>

                    <div class="step-tit">
                        <h3>支付方式</h3>
                    </div>
                    <div class="step-cont">
                        <ul class="payment-list">
                            <li data-value="1" class="payment-item-selected"><b></b>货到付款</li>
                            <li data-value="2"><b></b>支付宝支付</li>
                            <li data-value="3"><b></b>京东支付</li>
                            <li data-value="4"><b></b>在线支付</li>
                            <input form="form-order" type="hidden" name="payment" value="1">
                        </ul>
                    </div>
                    <div class="hr"></div>

                    <div class="step-tit">
                        <h3>送货清单</h3>
                    </div>
                    <div class="step-cont">
                        <section class="shopping-list">
                            <aside>
                                <div class="mode-item-tit">
                                    <h4>配送方式</h4>
                                </div>
                                <div class="mode-tab-nav">
                                    <span class="m-txt">京东快递<i class="qmark-icon qmark-tip"></i></span><b></b>
                                </div>
                                <div class="mode-list">
                                    <span class="mode-label ftx-03">标&nbsp;&nbsp;准&nbsp;&nbsp;达：</span>
                                    <br/>

                                    <div class="mode-infor">预计&nbsp;9月9日[周五]&nbsp;09:00-15:00&nbsp;送达</div>
                                </div>
                            </aside>
                            <div class="goods-list">
                                <div class="goods-tit">
                                    <h4 class="vendor_name_h" id="0">商家：京东自营</h4>
                                </div>
                                <div class="goods-items">
                                    <!--<div class="goods-item">
                                      <div class="p-img">
                                        <a target="_blank" href=""><img src="images/phone/phone_01.jpg" alt=""></a>
                                      </div>
                                      <div class="p-name">
                                        <a href="" target="_blank">
                                          小米 Note 全网通 白色 移动联通电信4G手机 双卡双待
                                        </a>
                                      </div>
                                      <div class="p-price">
                                        <strong class="jd-price">￥1199.00</strong>
                                        <span class="p-num">x1</span>
                                        <span class="p-state">有货</span>
                                      </div>
                                    </div>-->
                                </div>
                            </div>
                        </section>
                    </div>
                    <div class="hr"></div>

                    <div class="step-tit">
                        <h3>发票信息</h3>
                    </div>
                    <div class="step-content">
                        <div id="part-inv" class="invoice-cont">
                            <span class="mr10"> 普通发票（电子） &nbsp; </span>
                            <span class="mr10"> 个人&nbsp; </span>
                            <span class="mr10"> 明细&nbsp; </span>
                        </div>
                    </div>
                </section>
                <div class="order-summary">
                    <div class="statistic fr">
                        <div class="list">
                            <span><em class="ftx-01">3</em> 件商品，总商品金额：</span>
                            <em class="price" id="warePriceId" v="264">￥264.00</em>
                        </div>
                        <div class="list">
                            <span>运费：</span>
                            <em class="price"><i class="freight-icon"></i> ￥0.00</em>
                        </div>
                    </div>
                    <div class="clr"></div>
                </div>
                <div class="trade-foot">
                    <div class="trade-foot-detail-com">
                        <div class="fc-price-info">
                            <span class="price-tit">应付总额：</span>
                            <span class="price-num">￥0.00</span>
                            <input form="form-order" type="hidden" name="price" value="0">
                        </div>
                    </div>

                    <div id="checkout-floatbar" class="group">
                        <div class="checkout-buttons">
                            <button type="button" class="checkout-submit">
                                提交订单<b></b>
                            </button>
                        </div>
                        <span id="submit_message" style="display:none" class="submit-error"></span>

                        <div class="submit-check-info" id="submit_check_info_message" style="display:none"></div>
                    </div>

                </div>
            </div>

        </div>

    <div id="footer"></div>

<script src="js/jquery-1.12.4.min.js"></script>
<script>
    //功能点1： 若用户未登录，则跳转到登录页面
    if(!sessionStorage['loginUid']){
        location.href='productlist.html';
    }
    //功能点2 ： 异步请求页头和页尾
    $('#header').load('data/header.php', function () {
        $('#welcome').html('欢迎回来'+sessionStorage['loginUname'])
    })
    $('#footer').load('data/footer.php');

    //功能点3 根据用户编号，异步请求其购物车内容
    $.ajax({
        type:'GET',
        url:'data/6_cart_detail_list.php',
        data:{uid:sessionStorage['loginUid']},
        success:function(list) {
            console.log('开始处理订单商品信息');
            //console.log(list);
            var html = '';
            var sum = 0;//所有商品的总金额
            $.each(list, function (i, p) {
                sum += p.price * p.count;
                html += `
      <div class="goods-item">
        <div class="p-img">
          <a target="_blank" href=""><img src="${p.pic}"></a>
        </div>
        <div class="p-name">
          <a href="" target="_blank">${p.pname}</a>
        </div>
        <div class="p-price">
          <strong class="jd-price">￥${p.price}</strong>
          <span class="p-num">x${p.count}</span>
          <span class="p-state">有货</span>
        </div>
      </div>
      `;


            });
      $('.goods-items').html(html);//商品列表动态添加
      $('.price-num').html('￥'+sum.toFixed(2)).siblings(':hidden').val(sum);//修改总金额
        }
    })

    //修改支付方式
    $('.payment-list').on('click', 'li', function(){
        $(this).addClass('payment-item-selected').siblings('.payment-item-selected').removeClass('payment-item-selected');
        //修改隐藏域的value
        var v = $(this).data('value');//attr('data-value')
        $(this).siblings(':hidden').val(v);
    });

    //为提交订单绑定事件监听
    $('.checkout-submit').click(function(){
        //收集用户的所有输入——表单序列化
        var data = $('#form-order').serialize();
        data += '&userId='+sessionStorage['loginUid'];

        //异步提交表单数据，实现下单功能
        $.ajax({
            type: 'POST',
            url: 'data/order_add.php',
            data: data,
            success: function(obj){
                if(obj.code<0){
                    alert('订单生成失败！错误消息：'+obj.msg);
                }else {  //下单成功，保存订单编号给下一页面使用
                    sessionStorage['oid'] = obj.oid;
                    location.href='addorder_succ.html';
                }
            },
            error: function(){
                alert('订单提交失败！请查看响应消息！')
            }
        });
    });

    </script>

    </body>
</html>
